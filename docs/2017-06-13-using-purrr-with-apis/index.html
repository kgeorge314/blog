<!DOCTYPE html>
<html lang="en-gb">
    <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Hugo 0.25.1" />
    <title>Using purrr with APIs – revamping my code</title>
    
    
    
    <meta name="description" content="A description that will appear as a default if front matter does not exist" />
    <meta name="keywords" content='api,microsoft cognitive services,purrr,r,sentiment analysis' />
    
        <meta name="author" content="Steph" />
    
    
    <link href="" rel="alternate" type="application/rss+xml" title="Locke Data Blog" />
    <link rel="stylesheet" href="http://lockedata.uk/itsalockeblog/css/bootstrap.min.css" />
    <link rel="stylesheet" href="http://lockedata.uk/itsalockeblog/css/highlightjs-themes/androidstudio.css" />
    <link rel="stylesheet" href="http://lockedata.uk/itsalockeblog/css/font-awesome.min.css" />
    <link rel="stylesheet" href="http://lockedata.uk/itsalockeblog/css/lockedata.css" />
    
        
            <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
            <script>
                (adsbygoogle = window.adsbygoogle || []).push({
                    google_ad_client: "ca-pub-XXXXXX",
                    enable_page_level_ads: true
                });
            </script>
        
    
</head>

    <body>
        <!-- Navigation -->
<nav class="navbar navbar-default navbar-fixed-top">
  <div class="container">

    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      
        <a class="navbar-brand page-scroll" href="/itsalockeblog/#page-top">
          
          <img src="http://lockedata.uk/itsalockeblog/img/LockeDataTextNew.svg" class="img-responsive" alt="">
        </a>
      

    </div>
    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav navbar-right">
        <li class="hidden">
          <a href="/itsalockeblog/#page-top"></a>
        </li>
        
          <li>
            <a href="http://lockelife.com">Locke Data</a>
          </li>
        
          <li>
            <a href="/itsalockeblog/itsalockeblog/">Blog</a>
          </li>
        

        
        
      </ul>
    </div>
    <!-- /.navbar-collapse -->
  </div>
  <!-- /.container-fluid -->
</nav>

        <div id="top" class="container">
            <div class="row" id="content-main">
                <div class="col-md-8">
                    <div class="row">
    <div class="col-md-12 content-card">
        <h1>Using purrr with APIs – revamping my code</h1>
        
            
            <ul class="list-inline meta">
                <li><i class="fa fa-calendar"></i>June 13, 2017</li>
                <li><i class="fa fa-user"></i>Steph</li>
                
                    
                    <li><i class="fa fa-folder"></i><a href="http://lockedata.uk/categories/data-science">Data Science</a>, <a href="http://lockedata.uk/categories/microsoft-data-platform">Microsoft Data Platform</a>, <a href="http://lockedata.uk/categories/r">R</a></li>
                
            </ul>
        
        
    <ul class="list-inline share" style="margin-top: 15px; margin-left: 0px">
        <li class="facebook-share"><a target="_blank" href="http://www.facebook.com/sharer.php?u=http%3a%2f%2flockedata.uk%2fitsalockeblog%2f2017-06-13-using-purrr-with-apis%2f"><i class="fa fa-facebook fa-lg"></i>Facebook</a></li>
        <li class="googleplus-share"><a target="_blank" href="https://plus.google.com/share?url=http%3a%2f%2flockedata.uk%2fitsalockeblog%2f2017-06-13-using-purrr-with-apis%2f"><i class="fa fa-google-plus fa-lg"></i>Google+</a></li>
        <li class="twitter-share"><a target="_blank" href="https://twitter.com/share?url=http%3a%2f%2flockedata.uk%2fitsalockeblog%2f2017-06-13-using-purrr-with-apis%2f&amp;text=Using%20purrr%20with%20APIs%20%e2%80%93%20revamping%20my%20code"><i class="fa fa-twitter fa-lg"></i>Twitter</a></li>
        <li class="reddit-share"><a target="_blank" href="http://reddit.com/submit?url=http%3a%2f%2flockedata.uk%2fitsalockeblog%2f2017-06-13-using-purrr-with-apis%2f&amp;title=Using%20purrr%20with%20APIs%20%e2%80%93%20revamping%20my%20code"><i class="fa fa-reddit fa-lg"></i>Reddit</a></li>
        <li class="linkedin-share"><a target="_blank" href="http://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2flockedata.uk%2fitsalockeblog%2f2017-06-13-using-purrr-with-apis%2f"><i class="fa fa-linkedin fa-lg"></i>LinkedIn</a></li>
        <li class="stumbleupon-share"><a target="_blank" href="http://www.stumbleupon.com/submit?url=http%3a%2f%2flockedata.uk%2fitsalockeblog%2f2017-06-13-using-purrr-with-apis%2f&amp;title=Using%20purrr%20with%20APIs%20%e2%80%93%20revamping%20my%20code"><i class="fa fa-stumbleupon fa-lg"></i>StumbleUpon</a></li>
    </ul>


        

<p>I wrote a little while back about <a href="https://itsalocke.com/microsoft-cognitive-services-text-analytics-api/">using Microsoft Cognitive Services APIs with R</a> to first of all detect the language of pieces of text and then do sentiment analysis on them. I wasn&#8217;t too happy with the some of the code as it was very inelegant. I knew I could code better than I had, especially as I&#8217;ve been doing a lot more work with purrr recently. However, it had sat in drafts for a while. Then David Smith kindly posted about the <a href="http://blog.revolutionanalytics.com/2017/06/interfacing-with-apis.html">process I used</a> which meant I had to get this nicer version of my code out ASAP!</p>

<p>Get the complete code in this <a href="https://gist.github.com/stephlocke/441ea493be926b76bac59452a3f57281">gist</a>.</p>

<h2 id="prerequisites">Prerequisites</h2>

<ul>
<li>API access

<ul>
<li><a href="https://www.microsoft.com/cognitive-services/en-us/sign-up">A key</a></li>
<li><a href="https://www.microsoft.com/cognitive-services/en-us/text-analytics/documentation">An endpoint</a></li>
</ul></li>
<li>Packages

<ul>
<li><a href="https://cran.r-project.org/package=httr">httr</a></li>
<li><a href="https://cran.r-project.org/package=jsonlite">jsonlite</a></li>
<li><a href="https://cran.r-project.org/package=dplyr">dplyr</a></li>
<li><a href="https://cran.r-project.org/package=purrr">purrr</a></li>
</ul></li>
</ul>

<h2 id="setup">Setup</h2>

<pre><code class="r">library(httr)
library(jsonlite)
library(dplyr)
library(purrr)

cogapikey&lt;-"XXX"

text=c("is this english?"
       ,"tak er der mere kage"
       ,"merci beaucoup"
       ,"guten morgen"
       ,"bonjour"
       ,"merde"
       ,"That's terrible"
       ,"R is awesome")

# Put data in an object that converts to the expected schema for the API
data_frame(text) %&gt;% 
  mutate(id=row_number()) -&gt;
  textdf

textdf %&gt;% 
  list(documents=.) -&gt;
  mydata
</code></pre>

<h2 id="language-detection">Language detection</h2>

<p>We need to identify the most likely language for each bit of text in order to send this additional bit of info to the sentiment analysis API to be able to get decent results from the sentiment analysis.</p>

<pre><code class="r">cogapi&lt;-"https://westus.api.cognitive.microsoft.com/text/analytics/v2.0/languages?numberOfLanguagesToDetect=1"

cogapi %&gt;% 
  POST(add_headers(`Ocp-Apim-Subscription-Key`=cogapikey),
       body=toJSON(mydata)) -&gt;
  response

# Process response
response %&gt;% 
  content() %&gt;%
  flatten_df() %&gt;% 
  select(detectedLanguages) %&gt;% 
  flatten_df()-&gt;
  respframe

textdf %&gt;% 
  mutate(language= respframe$iso6391Name) -&gt;
  textdf
</code></pre>

<h2 id="sentiment-analysis">Sentiment analysis</h2>

<p>With an ID, text, and a language code, we can now request the sentiment of our text be analysed.</p>

<pre><code class="r"># New info
mydata&lt;-list(documents = textdf)

# New endpoint
cogapi&lt;-"https://westus.api.cognitive.microsoft.com/text/analytics/v2.0/sentiment"

# Construct a request
cogapi %&gt;% 
  POST(add_headers(`Ocp-Apim-Subscription-Key`=cogapikey),
       body=toJSON(mydata)) -&gt;
  response

# Process response
response %&gt;% 
  content() %&gt;%
  flatten_df() %&gt;% 
  mutate(id=as.numeric(id))-&gt; 
  respframe

# Combine
textdf %&gt;%
  left_join(respframe) -&gt;
  textdf
</code></pre>

<p>And&#8230; et voila! A multi-language dataset with the language identified and the sentiment scored using purrr for easier to read code.</p>

<p>Using purrr with APIs makes code nicer and more elegant as it really helps interact with hierarchies from JSON objects. I feel much better about this code now!</p>

<h2 id="original">Original</h2>

<table>
<thead>
<tr>
<th align="right">id</th>
<th align="left">language</th>
<th align="left">text</th>
<th align="right">score</th>
</tr>
</thead>

<tbody>
<tr>
<td align="right">1</td>
<td align="left">en</td>
<td align="left">is this english?</td>
<td align="right">0.2852910</td>
</tr>

<tr>
<td align="right">2</td>
<td align="left">da</td>
<td align="left">tak er der mere kage</td>
<td align="right">NA</td>
</tr>

<tr>
<td align="right">3</td>
<td align="left">fr</td>
<td align="left">merci beaucoup</td>
<td align="right">0.8121097</td>
</tr>

<tr>
<td align="right">4</td>
<td align="left">de</td>
<td align="left">guten morgen</td>
<td align="right">NA</td>
</tr>

<tr>
<td align="right">5</td>
<td align="left">fr</td>
<td align="left">bonjour</td>
<td align="right">0.8118965</td>
</tr>

<tr>
<td align="right">6</td>
<td align="left">fr</td>
<td align="left">merde</td>
<td align="right">0.0515683</td>
</tr>

<tr>
<td align="right">7</td>
<td align="left">en</td>
<td align="left">That&#8217;s terrible</td>
<td align="right">0.1738841</td>
</tr>

<tr>
<td align="right">8</td>
<td align="left">en</td>
<td align="left">R is awesome</td>
<td align="right">0.9546152</td>
</tr>
</tbody>
</table>

<h2 id="revised">Revised</h2>

<table>
<thead>
<tr>
<th align="left">text</th>
<th align="right">id</th>
<th align="left">language</th>
<th align="right">score</th>
</tr>
</thead>

<tbody>
<tr>
<td align="left">is this english?</td>
<td align="right">1</td>
<td align="left">en</td>
<td align="right">0.2265771</td>
</tr>

<tr>
<td align="left">tak er der mere kage</td>
<td align="right">2</td>
<td align="left">da</td>
<td align="right">0.7455934</td>
</tr>

<tr>
<td align="left">merci beaucoup</td>
<td align="right">3</td>
<td align="left">fr</td>
<td align="right">0.8121097</td>
</tr>

<tr>
<td align="left">guten morgen</td>
<td align="right">4</td>
<td align="left">de</td>
<td align="right">0.8581840</td>
</tr>

<tr>
<td align="left">bonjour</td>
<td align="right">5</td>
<td align="left">fr</td>
<td align="right">0.8118965</td>
</tr>

<tr>
<td align="left">merde</td>
<td align="right">6</td>
<td align="left">fr</td>
<td align="right">0.0515683</td>
</tr>

<tr>
<td align="left">That&#8217;s terrible</td>
<td align="right">7</td>
<td align="left">en</td>
<td align="right">0.0068665</td>
</tr>

<tr>
<td align="left">R is awesome</td>
<td align="right">8</td>
<td align="left">en</td>
<td align="right">0.9973871</td>
</tr>
</tbody>
</table>

<p>Interestingly the scores for English have not stayed the same &#8211; for instance, Microsoft now sees &#8220;R is awesome&#8221; in a much more positive light. It&#8217;s also great to see German and Danish are now supported!</p>

<p>Get the complete code in this <a href="https://gist.github.com/stephlocke/441ea493be926b76bac59452a3f57281">gist</a>.</p>

        
    <ul class="list-inline tags" style="margin-top: 15px; margin-left: 0px">
        
            <li style=""><a href="http://lockedata.uk/tags/api">api</a></li>
        
            <li style=""><a href="http://lockedata.uk/tags/microsoft-cognitive-services">microsoft cognitive services</a></li>
        
            <li style=""><a href="http://lockedata.uk/tags/purrr">purrr</a></li>
        
            <li style=""><a href="http://lockedata.uk/tags/r">r</a></li>
        
            <li style=""><a href="http://lockedata.uk/tags/sentiment-analysis">sentiment analysis</a></li>
        
    </ul>


    </div>
</div>

                    
    
        <div class="row">
            <div class="col-md-12 content-card">
                <div id="disqus_thread"></div>
                <script>
                    (function() {
                        if (window.location.hostname == "localhost") {
                            document.write("Disqus comments are unavailable while serving on localhost or 127.0.0.1");
                            return;
                        }
                        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                        var disqus_shortname = 'shortname';
                        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    })();
                </script>
                <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
            </div>
        </div>
    


                </div>
         <div class="col-md-4">                    
	
<div class="row">
    <div class="col-md-11 col-md-offset-1 card">
        <h5></h5>
        <p></p>
		<img class="avatar" src="img/ChibiSteph.svg"></img>
    </div>
</div>

    <div class="row">
    <div class="col-md-11 col-md-offset-1 card">
        <h5>Search</h5>
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form">
            <div class="input-group">
                <input class="form-control" type="search" name="q" />
                <span class="input-group-btn">
                    <button class="btn btn-primary" type="submit"><span class="glyphicon glyphicon-search"></span></button>
                </span>
            </div>
            <input type="hidden" name="q" value="site:">
        </form>
    </div>
</div>

    

</div>
            </div>
        </div>
        <!-- Footer section -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-md-4">
        <span class="copyright">
          <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.
        </span>
      </div>
      <div class="col-md-4">
        <ul class="list-inline social-buttons">
          
            <li>
              <a href="/itsalockeblog/#"><i class='fa fa-twitter'></i></a>
            </li>
          
            <li>
              <a href="/itsalockeblog/#"><i class='fa fa-facebook'></i></a>
            </li>
          
            <li>
              <a href="/itsalockeblog/#"><i class='fa fa-linkedin'></i></a>
            </li>
          
        </ul>
      </div>
      <div class="col-md-4">
        <ul class="list-inline quicklinks">
          
            <li>
              <a href="http://lockelife.com/#company">Legalise and stuff</a>
            </li>
          
        </ul>
      </div>
    </div>
  </div>
</footer>

        <div id="back-to-top" class="hidden">
    <a href="#top" class="well well-sm" onclick="$('html,body').animate({scrollTop:0},'slow');return false;">
        <i class="glyphicon glyphicon-chevron-up"></i> Back to Top
    </a>
</div>
<script src="http://lockedata.uk/itsalockeblog/js/jquery.min.js"></script>
<script src="http://lockedata.uk/itsalockeblog/js/bootstrap.min.js"></script>
<script src="http://lockedata.uk/itsalockeblog/js/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>
    if(($(window).height() + 100) < $(document).height()) {
        $('#back-to-top').removeClass('hidden').affix({
            offset: {
                top: 100
            }
        });
    }
</script>

    
        <script>
            
            [].forEach.call(document.querySelectorAll('.adsbygoogle'), function() {
                (adsbygoogle = window.adsbygoogle || []).push({});
            });
        </script>
    


    
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-XXXXX-YY', 'auto');
        ga('send', 'pageview');
    </script>




    </body>
</html>
